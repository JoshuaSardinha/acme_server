**Module: Task Instance Interaction & Data Handling**

**REQ-TASKINST-INTERACT-001**

- **Requirement Type:** Functional, API, Data, UI
- **Description:** When a user submits input for a task step (POST /v1/tasks/{taskInstanceId}/steps/{stepNumber}/submit-input), the API MUST:
  - Identify the DataPoints expected as input for the current TaskModelStep (derived from TaskModelDataPointLinks for the TaskInstance.task_model_id).
  - For each expected input DataPoint, validate the submitted data against its data_type and any validation_rules defined in the DataPoints table (e.g., regex, min/max length/value).
  - The submitted payload MUST support providing distinct data for each instance if TaskInstance.instance_count \> 1\.
  - For each submitted data point and for each instance_index (from 0 to TaskInstance.instance_count \- 1, if applicable): Create or update TaskInstanceData.
  - Update TaskInstance.completed_instance_count.
  - Client UI MUST allow providing distinct inputs for each instance and SHOULD provide client-side validation hints based on DataPoints.validation_rules and data_type.
-
- **Rationale:** Ensures data is validated against centrally defined rules in DataPoints.
- **Acceptance Criteria:**
  - API validates submitted data against DataPoints.data_type and DataPoints.validation_rules.
  - Data saved to TaskInstanceData. UI supports multi-instance input.
-
- **Priority:** Must Have
- **Standard/Reference:** Data Validation, OWASP A03:2021

**REQ-TASKINST-INTERACT-002**

- **Requirement Type:** Functional, API, Data
- **Description:** When a task step involves generating an output (e.g., a team member drafts a document, an AI process generates text), the API handling that step's completion MUST:
  - Identify the DataPoints expected as output for that step/task (from TaskModelDataPointLinks).
  - For each output DataPoint and for each instance_index (if applicable):
    - Create or update the corresponding record in TaskInstanceData, storing the output value/reference.
  -
-
- **Rationale:** Ensures outputs generated by team members or AI are also stored correctly in TaskInstanceData.
- **Acceptance Criteria:**
  - API correctly identifies expected output DataPoints for the step.
  - Output data/references are saved to TaskInstanceData for the correct task_instance_id, data_point_id, and instance_index.
-
- **Priority:** Must Have
- **Standard/Reference:** \-

**REQ-TASKINST-INTERACT-003**

- **Requirement Type:** Data, Functional
- **Description:** The system MUST support comments on Task Instances. A TaskComments table MUST be created, including:
  - id (Primary Key)
  - task_instance_id (FK to TaskInstances, NOT NULL)
  - user_id (FK to Users \- commenter, NOT NULL)
  - comment_text (TEXT, NOT NULL)
  - created_at (Timestamp)
  - is_feedback_for_rejection (Boolean, default: false) \- If true, this comment is the official reason for a review rejection.
-
- **Rationale:** Facilitates communication between clients and team members regarding specific tasks. Allows formal feedback on rejections.
- **Acceptance Criteria:**
  - TaskComments table schema exists.
  - API endpoints (POST /v1/tasks/{taskInstanceId}/comments, GET /v1/tasks/{taskInstanceId}/comments) exist for adding and retrieving comments, documented in OAS.
  - When a review is rejected (POST /v1/tasks/{taskInstanceId}/steps/{stepNumber}/reject-review), the API MUST require a comment to be submitted and flag it as is_feedback_for_rejection.
-
- **Priority:** Must Have
- **Standard/Reference:** OAS 3.x

**REQ-TASKINST-INTERACT-004**

- **Requirement Type:** Functional
- **Description:** Clients and assigned team members MUST be able to view the detailed description for the current task (from TaskModels.description_content_id) and the current step (from TaskModelSteps.description_content_id). The client application MUST render the rich content (HTML, Markdown, etc.) from the referenced ContentBlocks.
- **Rationale:** Provides necessary guidance using centrally managed rich content.
- **Acceptance Criteria:**
  - Client UIs retrieve and render content from the appropriate ContentBlocks for task and step descriptions.
-
- **Priority:** Must Have
- **Standard/Reference:** User Experience

**REQ-TASKINST-INTERACT-005**

- **Requirement Type:** Functional, Data Persistence
- **Description:** Client-side input progress for tasks (partially filled forms, documents selected for upload but not yet submitted) SHOULD be saved locally on the client device to prevent data loss if the app is closed. Upon returning to the task, this local state SHOULD be restored. Final submission still goes through the API.
- **Rationale:** Improves user experience by preserving work in progress.
- **Acceptance Criteria:**
  - Flutter client implements local state persistence for active task inputs.
  - State is restored when the user re-opens the task.
-
- **Priority:** Should Have
- **Standard/Reference:** Mobile App Best Practices

**REQ-TASKINST-INTERACT-006**

- **Requirement Type:** Functional, API, UI
- **Description:** The Task Details screen (as seen in mockup) MUST feature a "Request Assistance" option. Tapping this option will:
  - Present the user with relevant assistance options for the current TaskInstance. These options may include:
    - Upgrading the task to a different TaskModel (if available, linking to the Task Upgrade Selection Screen REQ-SCR-TUS-001). The GET /v1/tasks/{taskInstanceId}/available-upgrades API would be called.
    - Purchasing a relevant Benefit as an add-on (e.g., "1:1 Attorney Consultation") if not already acquired (linking to a focused add-on purchase screen, see REQ-ADDON-POST-001). The GET /v1/petitions/{petitionInstanceId}/available-addons API, possibly filtered for context-relevant benefits, would be called.
    - Initiating a support message/ticket related to this task (linking to a messaging interface or creating a new support ticket entry).
  -
  - The specific options presented MUST be contextually determined by the backend based on the task, its current model, available upgrades, and relevant purchasable benefits. An API endpoint (e.g., GET /v1/tasks/{taskInstanceId}/assistance-options) will provide these categorized options to the client.
-
- **Rationale:** Provides users with clear pathways to get help or enhance service for a specific task, improving user support and potentially driving upsells.
- **Acceptance Criteria:**
  - "Request Assistance" option is present on the Task Details UI.
  - API endpoint GET /v1/tasks/{taskInstanceId}/assistance-options exists, returning structured data on available upgrades, relevant add-ons, and/or support contact options.
  - Client UI correctly displays these options and navigates the user to the appropriate flow (Task Upgrade screen, Add-on purchase, or Support/Messaging).
  - Endpoint documented in OAS.
-
- **Priority:** Should Have
- **Standard/Reference:** User Support, In-App Upselling
